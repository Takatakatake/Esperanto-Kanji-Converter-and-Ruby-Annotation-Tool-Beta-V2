# Esperanto-Kanji-Converter-and-Ruby-Annotation-Tool

---

# エスペラント文を漢字置換＆Ruby注釈するアプリ — GUIユーザー向け説明書

以下に、本アプリケーション（Streamlit で構築された「エスペラント文の(漢字)置換ツール」および「(漢字)置換用 JSONファイル生成ツール」）の GUI ユーザー向け**操作マニュアル**を作成いたしました。  
大きく **「メインページ (main.py)」** と、Streamlit の「pages」フォルダ内にある **「エスペラント文(漢字)置換用のJSONファイル生成ページ.py」** の 2つのページで構成されています。  

---

# 【目次】

1. [本アプリ概要](#本アプリ概要)  
2. [セットアップおよびアプリの起動方法](#セットアップおよびアプリの起動方法)  
3. [メインページ (main.py) の使い方](#メインページ-mainpy-の使い方)  
   1. [① JSONファイル(置換ルール) の読み込み](#①-jsonファイル置換ルール-の読み込み)  
   2. [② placeholders (占位符) の内部処理](#②-placeholders-占位符-の内部処理)  
   3. [③ 高度な設定（並列処理）](#③-高度な設定並列処理)  
   4. [④ 出力形式の選択](#④-出力形式の選択)  
   5. [⑤ エスペラント文入力 (手動 or ファイル)](#⑤-エスペラント文入力-手動-or-ファイル)  
   6. [⑥ 変換実行と結果ダウンロード](#⑥-変換実行と結果ダウンロード)  
   7. [使い方の補足 / よくある質問](#使い方の補足--よくある質問)  
4. [エスペラント文(漢字)置換用のJSONファイル生成ページ (pages/内) の使い方](#エスペラント文漢字置換用のjsonファイル生成ページ-pages内-の使い方)  
   1. [ステップ1: 置換用の CSVファイル を準備](#ステップ1-置換用の-csvファイル-を準備)  
   2. [ステップ2: 語根分解ルール/置換文字列 設定用 JSONファイルを準備](#ステップ2-語根分解ルール置換文字列-設定用-jsonファイルを準備)  
   3. [ステップ3: 高度な設定 (並列処理)](#ステップ3-高度な設定-並列処理)  
   4. [ステップ4: 置換用JSONファイルの作成とダウンロード](#ステップ4-置換用jsonファイルの作成とダウンロード)  
   5. [サンプルファイル一覧](#サンプルファイル一覧)  
   6. [生成される JSON の概要](#生成される-json-の概要)  
5. [内部モジュール (esp_text_replacement_module.py, esp_replacement_json_make_module.py) について](#内部モジュール-esp_text_replacement_modulepy-esp_replacement_json_make_modulepy-について)  
6. [トラブルシューティング/注意事項](#トラブルシューティング注意事項)  
7. [付録：GitHub リポジトリについて](#付録github-リポジトリについて)  

---


## 本アプリ概要

このアプリは、

- **「エスペラント語の文章」に対し、あらかじめ定義した「漢字(あるいは訳語)」を置換し、HTMLルビ等の形式で表示・ダウンロードできるメイン機能**  
- **(その置換作業に使う)「置換用 JSONファイル」を自動生成する補助機能(別ページ)**  

を提供する Streamlit アプリケーションです。

- “main.py” がアプリのメインページとして機能します。  
- “エスペラント文(漢字)置換用のJSONファイル生成ページ.py” は、Streamlit の pages フォルダに配置される追加ページです。  

内部では大量のエスペラント語根・単語に対応するルビ(あるいは漢字置換用の文字列)を扱い、**既存の CSVファイルや JSONファイル**をもとにして「置換ルール」を作成・読み込み・適用しています。

---

## セットアップおよびアプリの起動方法

1. **Streamlit 環境**を用意し、当該リポジトリ(あるいはソースコード一式)をローカル/クラウドにクローンまたは配置します。  
2. `pip install streamlit` (未インストールの場合) および、コード内で使われている **pandas** や **multiprocessing** などのライブラリをインストールしてください。(多くは標準ライブラリとして含まれているか、`requirements.txt` 等に記載があるはずです)  
3. ターミナル(または Anaconda Prompt 等)で、アプリが配置されているディレクトリへ移動し、  
   ```
   streamlit run main.py
   ```
   と実行します。  
4. ブラウザが自動で立ち上がり、`http://localhost:8501` (または類似のポート番号)でアプリが表示されます。  

あとはブラウザ上で、以下の説明に沿ってご利用ください。


---

## メインページ (main.py) の使い方

まずはメインページ “main.py” について、画面の上から順番に説明します。

### ① JSONファイル(置換ルール) の読み込み

画面冒頭付近にあるラジオボタン

> **「JSONファイルをどうしますか？ (置換用JSONファイルの読み込み)」**  
>  - 「デフォルトを使用する」  
>  - 「アップロードする」  

を選択します。

- **「デフォルトを使用する」**  
  アプリ標準の「置換用 JSONファイル (./Appの运行に使用する各类文件/最终的な替换用リスト(列表)(合并3个JSON文件).json)」が読み込まれ、そこに定義されている置換ルールが自動的に適用されます。  

- **「アップロードする」**  
  手元にあるカスタマイズ済みの JSONファイル(=「すでに作り込んだ置換ルール」) をアップロードします。  
  - アップロード後、画面に「JSONの読み込み成功」のメッセージが出ればOKです。  
  - JSONファイル内には、以下のような3つのリストが含まれている想定です:  
    1. **replacements_final_list**  
    2. **replacements_list_for_localized_string**  
    3. **replacements_list_for_2char**  

もしエラーが出る場合は JSONファイルの形式に問題がないかご確認ください。


### ② placeholders (占位符) の内部処理

コード内部で、以下 2種類(＋α)のプレースホルダ文字列を読み込みます。  
- **`%...%`** で囲まれた部分 → 大域置換をスキップ (原文をそのまま保持)  
- **`@...@`** で囲まれた部分 → 「局部的に」文字列(漢字)置換を行い、大域置換との干渉を防ぐ  

これらはユーザーが文章に任意で書き込むための仕組みです。  
（例）  
- 「%...%」 → 完全に置換しないスキップ枠  
- 「@...@」 → その中だけ独自に変換したい語根を含む、等  

メイン画面で特に操作の必要はなく、「ステップ4」で入力するテキストの中に `%...%` や `@...@` を書くかどうか、自由にご利用ください。  
コード上では、これらを発見すると**一時的にプレースホルダに置き換え、他の置換との衝突を防ぐ**ようになっています。


### ③ 高度な設定（並列処理）

「高度な設定 (並列処理)」という見出しの下にあるエリアです。

- **「並列処理を使う」** にチェックを入れると、文字列置換をマルチプロセスで並列実行します。  
- **同時プロセス数**（2〜4あたり）を指定可能です。  

大規模なテキスト(数万行規模)を置換する場合に高速化することがありますが、Streamlit Cloud などの環境では CPUコア数が限られるため、かえって速度が安定しないケースもあり得ます。  
最初はチェックを外したまま(シングルプロセス)でお試しするのがおすすめです。


### ④ 出力形式の選択

「出力形式を選択(置換用JSONファイルを作成したときと同じ形式を選択):」というセレクトボックスで、以下のような7種類の形式から選べます。

- **HTML格式_Ruby文字_大小调整**  
  - 置換後の文字列を親文字 + ルビの形にし、さらにルビ文字のサイズや表示位置を自動調整するHTMLタグ形式  
- **HTML格式_Ruby文字_大小调整_汉字替换**  
  - 上と似ていますが、ルビ/親文字の立場が逆転したような形式(「漢字を親文字」「エスペラント原文をルビ」など)  
- **HTML格式**  
- **HTML格式_汉字替换**  
- **括弧(号)格式**  
  - 例：`Esperant(世界语)` のように `( )` でルビ(訳語など)を付記する  
- **括弧(号)格式_汉字替换**  
  - 逆に、`世界语(Esperant)` のように漢字を先頭にして括弧内に原文…  
- **替换后文字列のみ(仅)保留(简单替换)**  
  - 親文字やルビタグを使わず、「エスペラント語根 → 漢字(あるいは訳語)」へ置換した文字列だけを結果に出します。  
  - 極めてシンプルで、(HTMLタグ等をほぼ使わない)テキストベースの結果がほしい時に便利です。  

たとえば、**「HTML形式で漢字を大きめに表示し、ルビとしてエスペラント原文を振りたい」**という場合は  
「**HTML格式_Ruby文字_大小调整_汉字替换**」を選ぶとよいでしょう。


### ⑤ エスペラント文入力 (手動 or ファイル)

次に「入力テキストのソース」を選択します:

- **「手動入力」**  
  画面内のテキストエリアに直接エスペラント文を貼り付ける、あるいは文字を入力します。  
- **「ファイルアップロード」**  
  `.txt`, `.csv`, `.md` ファイル(UTF-8)をアップロードすると、その中身を読み込んでテキストエリアへ自動入力します。  

テキストエリアの下には、  
- **「出力文字形式」** → `上付き文字 (ĉ → cˆ)`, `x形式 (ĉ→cx)`, `^形式 (ĉ→c^)`  
が選べるラジオボタンがあります。  
これは、最終段階のエスペラント文字表記をどうするかのオプションです。  
（HTMLルビ付きの場合でも、この表記ルールが適用されますのでご注意ください。たとえばルビの中に含まれる `ĉ` が `cx` になるなど）


### ⑥ 変換実行と結果ダウンロード

1. テキストを入力/アップロードし、各種設定を選んだら  
2. 「送信」ボタンを押します。  

すると、ページ下部に**「置換結果プレビュー」** が表示されます。  
- HTML形式の場合は、**「HTMLプレビュー」タブ** と **「置換結果（HTMLソースコード）」タブ** に分かれています。  
- 括弧形式や単純テキストの場合は **「置換結果テキスト」** タブで内容を確認できます。

結果が長大な場合は、先頭一部＋末尾数行だけのプレビューとなります。（中ほどが `...` と省略される）

最後に **「置換結果のダウンロード」** ボタンが表示されるので、クリックすれば `.html` (デフォルト) 形式でファイルが保存されます。  
- **「HTML形式」系** を選んだ場合 → そのまま `<html>...</html>` を含むファイル  
- **「括弧形式」など** を選んだ場合 → テキストが `.html` 拡張子でダウンロードされますが、中身は純粋テキストなので、拡張子を`.txt`等に変えても問題ありません。  

### 使い方の補足 / よくある質問

- **Q1. 「@...@」や「%...%」 で囲んだ部分がうまく置換されません**  
  → 50文字 or 18文字の上限を超えていないか、@や%がちゃんと一対になっているかを確認してください。  

- **Q2. 「並列処理(マルチプロセス)」時、クラウド環境でエラー**  
  → Streamlit Cloud などでは `multiprocessing` の挙動が制限される場合があります。 その場合は「並列処理を使う」のチェックを外して再試行してください。  

- **Q3. エラー: JSONファイル 読み込み失敗**  
  → JSONの記述形式が壊れているか、キー名が想定と違う可能性があります。 「生成ページ (次項)」で作った JSONファイルを使うか、サンプル JSONをお試しください。  

---

## エスペラント文(漢字)置換用のJSONファイル生成ページ (pages/内) の使い方

本アプリには「エスペラント文の(漢字)置換用の JSONファイル」を**自動生成**するページが用意されています。  
**Streamlit アプリの左サイドバーや上部のメニュー**から `pages/` フォルダ内にある「エスペラント文(漢字)置換用のJSONファイル生成ページ.py」へ移動可能です。

### ステップ1: 置換用の CSVファイル を準備

ページを開くと、まず「ステップ1: CSVファイルを準備」という項目があります。  
- **「アップロードする」** → 新たに CSVファイルをアップロード (UTF-8 推奨)  
- **「デフォルトを使用する」** → アプリ同梱のサンプル CSVを利用  

CSVファイルは、
```
<エスペラント語根>, <その語根に対応させたい漢字(または日本語訳)>
```
の2列を基本とする形式です。  
エスペラント語根だけ書いて2列目が空の場合や、先頭に「#」が付いている行は無視されるよう実装されています。  

ここでアップロード/読み込みが成功すると、ページに「CSVファイルがアップロードされました」等のメッセージが表示されます。


### ステップ2: 語根分解ルール/置換文字列 設定用 JSONファイルを準備

次に

1. **「エスペラント単語の語根分解法を追加指定する JSONファイル」**  
2. **「置換後文字列を追加指定する JSONファイル」**  

を**アップロード or デフォルト使用**します。  
これらの JSON 内で「どのエスペラント単語にどんな接尾辞を加えて候補を増やすか」などの**細かいカスタマイズ**が行えます。

- 基本的には、サンプル JSON をそのまま使って問題ありません。  
- 大規模にカスタマイズしたい方は、サンプル JSON 内のコメントを参考に書き換え、アップロードしてください。  

#### これら JSONファイルの役割

- **「語根分解法 JSON」**  
  例: `["am", "dflt", ["verbo_s1"]]`  
  - `"am"` … エスペラント語根 “am”(愛する)  
  - `"dflt"` … 置換優先度などをデフォルト扱い  
  - `["verbo_s1"]` … 動詞活用 (as/is/os/us など) をまとめて追加するかどうか など。  

- **「置換後文字列 JSON」**  
  例: `[ "/am/iĝ", 100000, ["verbo_s2"], "/愛/化/" ]`  
  - 「`/am/iĝ` という語根分解で “愛化” を使う」 + `"verbo_s2"` → 動詞活用をプラス…など。  
  - 上級者向け機能であり、通常は不要です。  

**(より詳しい説明は、サンプル JSON ファイル内に書かれているコメントを参照してください)**


### ステップ3: 高度な設定 (並列処理)

「並列処理を使う」のチェックおよび「同時プロセス数」を設定できます。  
大きな CSVを扱う場合は高速化が期待できますが、環境によっては相性があるため、必要に応じて試してください。

### ステップ4: 置換用JSONファイルの作成とダウンロード

最後に「置換用JSONファイルを作成する」ボタンを押すと、進捗バーが表示され、**最終的な置換用 JSON** が生成されます。  
- 処理には数秒〜数十秒かかることがあります。  
- 完了すると「Download 最终的な替换用リスト(列表)(合并3个JSON文件).json」というダウンロードボタンが表示されます。  
- その JSONファイルをダウンロードし、**「main.py」(メインページ) で「アップロードする」オプション**を選んで取り込むことで、**独自の置換ルール**を使った変換を行えます。  

#### 実行の流れ例

1. CSV (エスペラント語根→自作の漢字対応) をアップロード  
2. デフォルトの語根分解 JSON を使う  
3. ボタンを押して生成  
4. 生成された JSON をダウンロード  
5. メインページで「JSONをアップロードして使う」を選んで、そのファイルを指定  
6. 独自カスタム置換がメインページで反映される  

### サンプルファイル一覧

ページ中央付近の折りたたみ「サンプルファイル一覧(ダウンロード用)」に、各種 CSV/JSON/Excel サンプルが用意されています。  
- 「エスペラント語根-日本語訳ルビ対応リスト.csv」など基本例  
- 「Mingeo氏の漢字化案 CSV」  
- 「エスペラント単語語根分解法ユーザー設定.json」 … 接頭辞・接尾辞などの例  
- などなど  

必要に応じてダウンロードして、参考や下敷きにしてください。

### 生成される JSON の概要

作成される最終的な JSON は、ざっくり次の3部構成を持ちます。  

```jsonc
{
  "全域替换用のリスト(列表)型配列(replacements_final_list)": [
    // (E単語, 置換後文字列, placeholder) のタプル配列 (多数)
    // 文字数が多いものほど先に置換されやすいように並び替え済み
  ],
  "二文字词根替换用のリスト(列表)型配列(replacements_list_for_2char)": [
    // 2文字語根(または接頭辞・接尾辞・単独語)用の追加置換リスト
  ],
  "局部文字替换用のリスト(列表)型配列(replacements_list_for_localized_string)": [
    // @...@ 内部のローカル置換に使う簡易リスト
  ]
}
```

- これらを **「main.py」の大域置換**や**局部置換**に流し込むことで、複雑なエスペラント文の漢字化・ルビ化を実現しています。  
- 必要があれば JSON をテキストエディタで開いて中身を確認し、語根がどのように置換されるかチェックしてみてください。

---

## 内部モジュール (esp_text_replacement_module.py, esp_replacement_json_make_module.py) について

本アプリのロジック（エスペラント特有文字の変換、@...@ や %...% の扱い、ルビ付与ロジック、JSON生成のワークフローなど）は、下記 2つの Pythonモジュールに集約されています。

1. **esp_text_replacement_module.py**  
   - 「main.py」でインポートされ、実際のテキスト置換を担う関数群  
   - `orchestrate_comprehensive_esperanto_text_replacement` や、`parallel_process`（並列化）などが定義  

2. **esp_replacement_json_make_module.py**  
   - 「エスペラント文(漢字)置換用 JSONファイル 生成ページ」でインポートされ、  
     大量のエスペラント語根をまとめて置換 → JSON化する流れを実装  
   - `output_format` や `parallel_build_pre_replacements_dict` などの関数が含まれる  

直接触れる必要は基本ありませんが、  
**「他のプログラムに組み込みたい」「自分で細かくカスタマイズしたい」** という方はご確認いただけます。

---

## トラブルシューティング/注意事項

1. **大規模 JSON や 大量テキストの場合**  
   - 50MB級の JSONを読み込むときなど、一度読み込んだらキャッシュ(@st.cache_data)を活用する仕組みで高速化していますが、初回はやはり時間がかかることがあります。ブラウザが固まったように見えても少し待ってみてください。  
2. **マルチプロセスの挙動**  
   - Windows環境では `if __name__ == "__main__":` ブロックがあるかなどに注意が必要ですが、Streamlitアプリでは `multiprocessing.set_start_method("spawn")` を明示的に指定してPicklingErrorを回避する仕組みを入れています。  
   - 実行環境によっては、並列処理が制限されたり、かえって遅くなる場合もあるので、適宜オンオフしてください。  
3. **ファイルのエンコード**  
   - CSVや TXT ファイルはなるべく UTF-8 (BOMなし) で準備してください。  
   - Shift_JIS や Excel系の文字コードだと意図せず文字化けする場合があります。  
4. **スキップ/局部置換を多用する文章**  
   - `%...%` や `@...@` が重複するとき、長文の中で本当に想定どおりの箇所のみ置換されているか、プレビュー等でご確認をおすすめします。  

---

## 付録：GitHub リポジトリについて

メインページ末尾にもリンクが示されているとおり、このアプリのソースコードは以下でホスティングされています:

> [GitHub: Takatakatake/Esperanto-Kanji-Converter-and-Ruby-Annotation-Tool-](https://github.com/Takatakatake/Esperanto-Kanji-Converter-and-Ruby-Annotation-Tool-)

不具合報告や Pull Request は大歓迎とのことです。  
実際のところ、エスペラント語根の正確な漢字割り当てやルビ割り当ては試行錯誤の余地が大きく、上記リポジトリでも随時更新される可能性がありますので、最新版をチェックしてみてください。

---

以上が、本アプリの GUI ユーザー向けの詳しい説明書（操作マニュアル）です。  
**「エスペラント文の漢字化」**という非常に面白い試みのツールとして、ぜひ活用していただければ幸いです。  

何かご不明な点がありましたら、エラーメッセージや画面キャプチャ等を添えてご質問いただければと思います。  

ご利用、ありがとうございました。  
