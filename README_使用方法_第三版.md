# Esperanto-Kanji-Converter-and-Ruby-Annotation-Tool

---

# エスペラント文を漢字置換＆Ruby注釈するアプリ — GUIユーザー向け説明書

## 目次
1. **アプリ概要**
2. **アプリを構成する4つの Python コードの役割**
3. **メインページ（`main.py`）の使い方**
   1. JSONファイル（置換ルール）の読み込み
   2. プレースホルダー（%...%・@...@）の仕組み
   3. 高度な設定（並列処理）
   4. 出力形式の選択
   5. 入力テキストの指定（手動入力 / ファイルアップロード）
   6. 変換結果のプレビュー＆ダウンロード
   7. GitHubリポジトリへのリンク
4. **サブページ（`エスペラント文(漢字)置換用のJSONファイル生成ページ.py`）の使い方**
   1. ページ概要：大量の置換ルールを JSON 化する
   2. サンプルファイルのダウンロード
   3. 出力形式（HTML、括弧形式等）の指定
   4. CSVファイルのアップロードまたはデフォルト使用
   5. JSONファイル（語根分解法等）のアップロードまたはデフォルト使用
   6. 高度な設定（並列処理）
   7. 生成した JSON ファイルをダウンロード
5. **補助モジュール（`esp_text_replacement_module.py` / `esp_replacement_json_make_module.py`）の補足**
6. **よくある質問（Q&A）と注意点**

---

## 1. アプリ概要

このアプリは「**エスペラント文を（漢字）置換し、さらに HTML 形式のルビ注釈なども付与**する」という目的で作られた Streamlit アプリです。主に次の2つの機能から成ります：

1. **エスペラント文 → (漢字＋ルビ)への一括変換（`main.py`）**  
   手動入力やテキストファイルをアップロードして、ボタンを押すだけで処理結果が得られます。

2. **大量の置換ルール（JSONファイル）を作成するツール（`エスペラント文(漢字)置換用のJSONファイル生成ページ.py`）**  
   CSV やユーザー定義の JSON（語根分解ルールなど）を用いて、最終的な「置換用 JSON」を自動生成します。  
   この JSON をメインページで読み込むことにより、複雑な置換やカスタム漢字対応が可能になります。

内部的には以下のモジュールが関わります：

- `esp_text_replacement_module.py`: 文字列置換の中核（%...%スキップ、@...@局所置換、並列処理など）  
- `esp_replacement_json_make_module.py`: 置換ルール JSON 作成時の補助（CSV 合体、語根派生、優先順位付け等）

---

## 2. アプリを構成する4つの Python コードの役割

1. **`main.py`**  
   - **アプリのメインページ**として起動されるファイル。  
   - ユーザーが実際に「世界語の文章を入力 → 漢字置換 + ルビ付け」し、結果をダウンロードできます。  
   - JSONファイル（置換ルール）をどう読み込むか、並列処理を使うか等の設定 UI が揃っています。

2. **`エスペラント文(漢字)置換用のJSONファイル生成ページ.py`**  
   - Streamlit の `pages` フォルダに置かれ、サブページとして機能するファイル。  
   - CSV やユーザー設定 JSON を読み込み、大量の派生形（名詞語尾、動詞活用等）を自動生成して **「置換用 JSON」** を作るツール。  
   - 出来上がった JSON をダウンロードし、それを `main.py` 側でアップロードして使う流れ。

3. **`esp_text_replacement_module.py`**  
   - 世界語特有の文字（ĉ など）や `%...%` 跳び、`@...@` 局所置換、並列処理を統合した「**文字列置換の本体**」。  
   - `main.py` でテキストを変換するときに呼び出されます。

4. **`esp_replacement_json_make_module.py`**  
   - CSV から読み取ったエスペラント語根→翻訳語などを合成して JSON 化する機能を集めたモジュール。  
   - 文字幅を計測して `<br>` を挿入し、Ruby 表示を整えるロジックなども含まれています。  
   - `エスペラント文(漢字)置換用のJSONファイル生成ページ.py` で主に呼び出されています。

---

## 3. メインページ（`main.py`）の使い方

### 3.1. JSONファイル（置換ルール）の読み込み

- 起動すると、まず **「JSONファイルをどうしますか？」** のラジオボタンが表示されます。  
  - 「デフォルトを使用する」  
  - 「アップロードする」  
- **デフォルトを使用** にすると、アプリ内蔵のサンプル JSON が読み込まれます。（`load_replacements_lists()` が呼ばれ、事前にキャッシュして高速化）  
- **アップロード** にすると、ユーザーが手元にある `XXX.json` をアップロードでき、そこに含まれる大量の置換ルールが適用されます。  
- また、画面下部には**「サンプルJSONファイルのダウンロード」** ボタンもあるので、自作の JSON を作りたい人は参照してください。

### 3.2. プレースホルダー（%...%・@...@）の仕組み

- このアプリでは、  
  - **`%...%` で括る部分は「置換をスキップ」**  
  - **`@...@` で括る部分は「局所置換専用のリスト（replacements_list_for_localized_string）で処理」**  
- 実装上は「プレースホルダー（placeholder）を差し込む → 全域置換をスキップ／別リストで置換 → 最後に元へ戻す」という段取りです。  
- `import_placeholders(...)` によりプレースホルダーが自動読み込まれ、ユーザーは特に意識する必要はありません。  
- ただし「この単語だけ置換したくない」「ここだけ特殊に置換したい」といったときに `%`・`@` を活用できます。

### 3.3. 高度な設定（並列処理）

- メインページ中ほどに **「並列処理を使う」チェックボックス** と **「同時プロセス数」** があります。  
- ここで ON にすると、多数行にわたるテキストを分割し、CPUコアを活用して並列変換します。  
  - テキスト行数が少ない場合はあまり恩恵がなく、逆にオーバーヘッドで遅くなる可能性もあるので状況に応じてお試しください。

### 3.4. 出力形式の選択

- **「出力形式を選択」** のセレクトボックスで、置換結果がどう表示されるか指定します。  
  - 例：`HTML格式_Ruby文字_大小调整` → `<ruby>esperant<rt class="S_S">エスペラント</rt></ruby>` という Ruby タグ付き HTML  
  - 例：`括弧(号)格式` → `esperant(エスペラント)`  
  - 例：`替换后文字列のみ(簡単置換)` → 単純に訳語だけを出力  
- 「漢字替換」の付く形式を選ぶと、**メイン部分に漢字を、ルビ部分にエスペラントを振る**など逆の表示も可能です。

### 3.5. 入力テキストの指定（手動入力 / ファイルアップロード）

- 画面下部で、**「入力テキストをどうしますか？」** → 「手動入力 / ファイルアップロード」 を選びます。  
- **ファイルアップロード**：`txt` や `csv`、`md` などの UTF-8ファイルを選択すれば、その内容が読み込まれ、テキストエリアに反映されます。  
- **手動入力**：テキストエリアにエスペラント文を自由に貼り付け/入力してください。

### 3.6. 変換結果のプレビュー＆ダウンロード

1. 入力後、**「送信」** ボタンを押すと変換が実行され、内部では以下の処理が進みます：  
   - `%...%` スキップ部の一時退避  
   - `@...@` の局所置換  
   - 大域置換（JSONファイルのルールを反映）  
   - 2文字語根の二重置換  
   - もし **並列処理** を有効にしていればプロセスプールを使って行ごとに分割→並列実行  

2. 完了すると、**画面下部に結果**が表示されます。  
   - 行数が膨大な場合、最初の 200+ 行 ＋ 後ろ 3 行だけ表示する形で省略します。  
   - 出力形式が **HTML** のときは、プレビュータブ (埋め込み HTML) とソースコードタブ の2つが表示されます。

3. **「ダウンロードボタン」** から `.html` として保存できます。  
   - オフラインでブラウザに開けば、そのままルビ表示や漢字化を確認できます。

### 3.7. GitHubリポジトリへのリンク

- ページ末尾に **「アプリのGitHubリポジトリ」** のリンクが表示されます。  
- 中身のコードを確認したい、イシューを報告したい場合はそこから行えます。

---

## 4. サブページ（`エスペラント文(漢字)置換用のJSONファイル生成ページ.py`）の使い方

### 4.1. ページ概要：大量の置換ルールを JSON 化する

- Streamlit の特性で、`pages/` フォルダに置いた Python ファイルとして表示されるサブページです。  
- **エスペラント語根と翻訳語などを載せた CSV を読み込み、さらにユーザー定義 JSON（語根分解法）などを合体して、「大規模置換ルール JSON」** を作る機能を提供します。  
- 後ほど `main.py` でこの JSON をアップロードすれば、非常に細やかな置換が可能になります。

### 4.2. サンプルファイルのダウンロード

- ページ冒頭で **「サンプルファイル一覧」** 折りたたみが表示され、以下のようなファイルを取得できます：  
  - **サンプルCSV** (エスペラント語根 → 漢字 or 日本語訳)  
  - **サンプルJSON** (語根分解法 / 置換後文字列の設定)  
  - **サンプルExcel** (語根に対する備考・習得レベルなど)  
- これらを活用して、独自の CSV/JSON を編集・作成し、アップロードしてみましょう。

### 4.3. 出力形式（HTML、括弧形式等）の指定

- 画面中ごろの **「出力形式を選択」** ボックスで、「HTML形式（ルビあり / ルビ＋漢字置換）」や「括弧形式」「単純置換」などを選びます。  
- これによって JSON 内に格納される「置換後文字列」自体が `<ruby>...</ruby>` 形式、もしくは `( )` 形式などで書き込まれます。  
- メインページで同じ出力形式を選択すると、正しく組み合わさるわけです。

### 4.4. CSVファイルのアップロードまたはデフォルト使用

- **「ステップ１：CSVファイルを準備」** の項目で、  
  - 「アップロードする」 → 手元の CSV（世界語根 → 漢字/日本語訳）を UTF-8 形式でアップロード  
  - 「デフォルトを使用する」 → 内蔵サンプル CSV を読み込み  
- CSV が読み込まれると **pandas** で最初の2列（語根 / 翻訳）を取得し、内部で世界語表記（cx, c^ → ĉ等）に統一されます。

### 4.5. JSONファイル（語根分解法等）のアップロードまたはデフォルト使用

- **「ステップ２：JSONファイルを準備」**  
  1. 「エスペラント単語語根分解法の JSON」  
  2. 「置換後文字列のユーザー設定 JSON」  
- いずれもアップロード or デフォルト使用が可能です。  
- 例えば「`verbo_s1`」等の指定により、動詞語根に as/is/os/us などの活用語尾を自動付与する仕組みを追加できます。

### 4.6. 高度な設定（並列処理）

- **「ステップ３：高度な設定（並列処理）」**  
  ここもメインページ同様、多プロセス処理が可能です。  
- 大量の語根（数万規模）を CSV + JSON で合体する際、並列化による速度向上が期待できます。

### 4.7. 生成した JSON ファイルをダウンロード

1. 画面下に **「置換用JSONファイルを作成する」ボタン** を押すと、  
   - CSV 内の語根 → 漢字化  
   - 語尾（o, on, e, as, is...）の派生単語生成  
   - ユーザー定義 JSON の特殊設定合体  
   - ソートして placeholder を割り振る …等、非常に多段階な処理が走ります。  
2. 完了すると **「Download 最终的な替换用リスト(合并3个JSON文件).json」** ボタンが出現し、すぐに保存可能。  
3. このダウンロードした JSON を、メインページで「アップロードする」選択時に指定すればOKです。

---

## 5. 補助モジュール（`esp_text_replacement_module.py` / `esp_replacement_json_make_module.py`）の補足

- 通常、GUIユーザーとしては直接編集しなくてもよいですが、仕組みを把握する際には役立ちます。  

### 5.1. `esp_text_replacement_module.py`
- **`orchestrate_comprehensive_esperanto_text_replacement()`**  
  - `%...%` 避け → `@...@` 局所 → 大域 → 2文字語根 → 復元 → HTML化  
  - メインページの「送信」ボタンが押されたとき、ほぼこの関数で一括処理されます。  
- **並列処理関数** `parallel_process(...)`  
  - テキストを行単位で切り、複数コアで処理 → 結合。

### 5.2. `esp_replacement_json_make_module.py`
- **`output_format(...)`**  
  - 「HTML ルビ」「括弧形式」「単純置換」など、ユーザーが選んだ出力形式に応じた文字列生成。  
  - 文字幅計測し、長すぎる場合 `<br>` を挿入するなどの工夫も。  
- **`parallel_build_pre_replacements_dict(...)`**  
  - CSV や大辞典を並列処理し、派生形を大量に構築。  
  - 最終的に JSON に書き出すためのリストをまとめる。  

---

## 6. よくある質問（Q&A）と注意点

### Q1. `%...%` と `@...@` をどう使い分ければいい？

- `%...%`：該当箇所の文字列は一切変換したくないとき。  
  - 例：`Mi havas %nombro% da libroj.` → `nombro`だけは置換されず原文のまま。  
- `@...@`：該当箇所の文字列だけ、**局部的な置換ルール**（replacements_list_for_localized_string）を適用したいとき。  
  - 例：`Mi @amas@ vin.` → `amas` は別枠のルールで変換される。

### Q2. 並列処理をONにするメリット / デメリット

- **メリット**：文章やデータが非常に大量（数万行など）あるときに速度向上が期待できる。  
- **デメリット**：小規模テキストではプロセス起動のオーバーヘッドで逆に遅くなる可能性あり。また環境（クラウド）によっては制限がかかる場合がある。

### Q3. ダウンロードしたファイル（.html / .json / .csv）はどう使う？

- **`.html`**：メインページで得られた結果。オフラインでもブラウザで開け、Ruby 注釈や漢字表示が確認できます。  
- **`.json`**：置換ルール。メインページの「JSONファイルをアップロード」で選択し、複雑な漢字化を実現できます。  
- **`.csv`**：サブページで再度取り込み、あるいは Excel で編集して独自ルールを追加できます。

### Q4. 文字化けやエラーが起きる場合は？

- **UTF-8** のファイルを用意するのが基本。Shift-JIS 等をアップロードすると文字化けの恐れ。  
- JSON ファイルは正しい構文（`{...}`, `[...]` の対応など）になっているかご確認ください。

### Q5. 置換後のルビがブラウザでずれる

- `HTML格式_Ruby文字_大小调整` は高度な CSS を用いていますが、ブラウザによっては完全に同じには表示されない場合があります。  
- もし問題が大きいときは、**「括弧(号)形式」** 等のシンプルな出力に切り替えるか、ご自身で CSS を微調整してください。

---

# まとめ

- **メインページ（`main.py`）**  
  - ユーザーが最終的に世界語文を入力し、JSON ルールに基づいて漢字置換・ルビ付与を行う場  
  - `%...%` / `@...@` の特殊指定や並列処理の設定、出力形式選択などを行い、結果をダウンロードできる

- **サブページ（`エスペラント文(漢字)置換用のJSONファイル生成ページ.py`）**  
  - CSV・JSON 合体で**大規模な置換ルール（漢字/活用/派生/特殊設定）**を作り、1つの JSON にまとめる場  
  - これをダウンロードし、メインページで「アップロードする」ことで反映可能

- **補助モジュール 2つ**  
  - `esp_text_replacement_module.py`：実際の文字列置換・並列処理、本体  
  - `esp_replacement_json_make_module.py`：JSON 作成時の細分化ロジックやルビテクニック

本ガイドを参考に、ぜひエスペラント文をお好みの漢字や訳語に自在に変換してみてください。もし大規模翻訳を試したい場合、サブページで独自 CSV / JSON を作成することがカギとなります。分からない点は GitHub リポジトリを参照したり、Issue でご質問ください。  
